{% extends "searchBase.html" %}
{% load static %}
{% block content %}
{% load bootstrap4 %}
<div class="feed-result">
  <p class="my_search_text">검색 결과: <b>"{{query}}"</b></p>
  <p><a href="{% url 'user:main' %}">메인으로 이동하기</a></p>
</div>


<div class="feedNtag-container">
  <div class="feed-list white-form" id ='feed-list'>
    <div class="feed-addContainer">
      <div class="feed-add">
        {% if request.user.userImg %}
        <img src="{{ request.user.userImg.url }}" class="feed--userImg" alt="userImg">
        {% else %}
        <img src="{% static 'img/default.jpeg' %}" class="feed--userImg" alt="userImg">
        {% endif %}
        <input  type="text" type="submit" placeholder="글을 작성하려면 누르세요" data-bs-toggle="modal" data-bs-target="#feedForm" />
  
      </div>
      {% if request.user.id %}
      <div class="feed-filterBtn">
        <a href="{% url 'user:searchMyFeed' %}"><button class="feed-my" value="myFeed">내 글 모아보기</button></a>
        <a href="{% url 'user:searchLikedFeed' %}"><button class="feed-like">좋아요 모아보기</button></a>
      </div>
      {% endif %}
    </div>
  
    {% for feed in feeds %}
  
    {% if request.user.id != feed.userId.id%}
    <div class="feed-container">
      <div class="feed--userInfo">
        {% if feed.userId.userImg %}
        <img src="{{ feed.userId.userImg.url }}" class="feed--userImg" alt="userImg">
        {% else %}
        <img src="{% static 'img/default.jpeg' %}" class="feed--userImg" alt="userImg">
        {% endif %}
        <p class="feed--userName">{{feed.userId.nickName}}</p>
      </div>
      <div class="feed--content white-form">
        <div class="feed--content-top">
          <div class="feed--content-left">
            <p class='feed-title'><span>Listening... </span>{{feed.artist}} - {{feed.music}}</p>
            <p class='feed-content'>{{feed.content}}</p>
            {% if feed.feedImg %}
            <img src="{{feed.feedImg.url}}" alt="">
            {% endif %}
            <p>{{feed.createdDate}}</p> 
          </div>
          <div class="feed--content-right">
            <div class="feed-heart">  
              {% if request.user.is_authenticated %}
              <div>
                {% if user in feed.like_users.all %}
                <i class="fas fa-heart likeButton" data-id="{{ feed.id }}" style="color:red"></i>
                {% else %}
                <i class="far fa-heart likeButton" data-id="{{ feed.id }}" style="color:red"></i>
                {% endif %}
              </div> 
                <div id="like-count-{{ feed.id }}">{{ feed.like_users.count }}</div>
              {% endif %}
              </div>
          </div>
        </div>
        <div class="feed--content-bottom">
          <div class="feed-hashtagList">
            {% for tag in feed.tags.all %}
            <div class="hashtag--btn">{{tag}}
            </div>
            {% endfor %}
          </div>
        </div>
        
      </div>
    </div>
    
    {% else %}
    <div class="feed-container">
    <div class="feed--content-my white-form">
      <div class="feed--content-top">
        <div class="feed--content-left">
          <p class='feed-title'><span>Listening... </span>{{feed.artist}} - {{feed.music}}</p>
          <p class='feed-content'>{{feed.content}}</p>
          {% if feed.feedImg %}
          <img src="{{feed.feedImg.url}}"  alt="">
          {% endif %}
          <p>{{feed.createdDate}}</p> 
        </div>
        <div class="feed--content-right">
          <div class="feed-twobtn">
            <a href="{% url 'user:updateFeed' feed.id %}">수정</a>
            <a href="{% url 'user:deleteFeed'  feed.id %}">삭제</a>
          </div>
          <div class="feed-heart">  
              {% if request.user.is_authenticated %}
              <div>
                {% if user in feed.like_users.all %}
                <i class="fas fa-heart likeButton" data-id="{{ feed.id }}" style="color:red"></i>
                {% else %}
                <i class="far fa-heart likeButton" data-id="{{ feed.id }}" style="color:red"></i>
                {% endif %}
              </div>
                <div id="like-count-{{ feed.id }}">{{ feed.like_users.count }}</div>
              {% endif %}
          </div>
        </div>
      </div>
      <div class="feed--content-bottom">
         
        <div class="feed-hashtagList">
          {% for tag in feed.tags.all %}
          <div id="hashTag" class="hashtag--btn">{{tag}}</div>
          {% endfor %}
          {% if feed.inputTags %}
            <div id ="newHash" style="display:none";>{{feed.inputTags}}</div>
            <script>
              const hashTag = document.querySelector("#newHash").innerHTML;
              console.log(hashTag);
              addInputTag(hashTag);
              function addInputTag(tags) {
                console.log("!!")
                const hashTagArray = tags.split(' ');
               
                for (let i=0; i < hashTagArray.length; i++) {
                  const newDiv = document.createElement('div');
                  newDiv.setAttribute("class", "hashtag--btn");
                  const newText = document.createTextNode(hashTagArray[i]);
                  newDiv.appendChild(newText);
                  const tagDiv = document.querySelector('.feed-hashtagList');
                  tagDiv.append(newDiv);
                };
              }
          </script>
          {% endif %}
        </div>
      </div>
      
    </div>
    <div class="feed--userInfo">
      {% if feed.userId.userImg %}
      <img src="{{ feed.userId.userImg.url }}" class="feed--userImg" alt="userImg">
      {% else %}
      <img src="{% static 'img/default.jpeg' %}" class="feed--userImg" alt="userImg">
      {% endif %}
      <p class="feed--userName">{{feed.userId.nickName}}</p>
    </div>
  </div>
    {% endif %}
    
    {% empty %}
  
    <div class="empty-feed">
      <p class="my_search_text">
        해당 노래/가수의 피드가 아직없네요! 피드를 생성해보세요! &nbsp
      </p>
      <p><a href="{% url 'user:main' %}">메인으로 이동하기</a></p>
    </div>
  
    {% endfor %}
  </div>
  <!--
  <div class="tag-list tagClose white-form" id = 'tag-list'>
    <h1>추천 태그</h1>
    {% for feed in feeds %}
    {% for tag in feed.tags.all %}
    <ul>{{tag}}</ul>
    {% endfor %}
    {% endfor %}
  </div>-->
  <div id ="tag-list-btn"  class="tag-list-btn">추천태그</div>
  <div class="tag-list tagClose" id = 'tag-list'>
    {% for feed in feeds %}
    {% for tag in feed.tags.all %}
    <ul class="tag">{{tag}}</ul>
    {% endfor %}
    {% endfor %}
  </div>
  </div>



<!-- 피드 등록 폼 modal -->
<div id="feedForm" class="modal fade" style="color: black;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" style="color: black;">피드 등록하기</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <form class="searchDiv" action="methods" enctype="multipart/form-data">
            <label for="songinfo">음악 검색</label>
            <div>
              <input type="text" id="songinfo" style="width: 120%;" class="whatToSearch" placeholder="검색" autocomplete="off" />
              <input type="text" style="display: none" />
              <button type="button" class="" style="width: 40%;" onclick="addMusicList()">검색</button>
            </div>
          </form>
        </div>
        <div class="musicListList"></div>

        <button id="registerMusic" style="width: 25%;" onclick="registerMusic()">노래 등록</button>
        <form method="POST" class="post-form" enctype="multipart/form-data">

          {% csrf_token %} {{ form.as_p }}

          <button type="submit" class="saveFeedForm">Save</button>
        </form>
      </div>
    </div>
  </div>
</div>
<script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc="
  crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
{% endblock %}
{% block js %}
<script src='{% static "js/feedpage.js"%}'></script>
<script src='{% static "js/feedLike.js"%}'></script>
<script>
  let musicListListList = document.querySelector('.musicListList')
  const musictitleInput = document.querySelector('.musicTitleInput')
  const musicartistInput = document.querySelector('.musicArtistInput')
  $(document).ready($(".musicList").empty());

  function addMusicList() {
    musicListListList.style.display='block';
    let musicKeyWord = $("#songinfo").val();
    $(".musicList").empty();
    $(".musicListList").empty();
    $.ajax({
      type: "GET",
      url:
        "http://ws.audioscrobbler.com/2.0/?method=track.search&track=" +
        musicKeyWord +
        "&api_key=91921c9761d97539ea8147f4599b5f3e&format=json",
      success: function (response) {
        let musicList = response["results"]["trackmatches"]["track"];
        for (let i = 0; i < musicList.length; i++) {
          let albumTitle = musicList[i]["name"];
          let albumArtist = musicList[i]["artist"];
          getMusicHtml(albumTitle, albumArtist);
        }
      },
    });
  }

  function getMusicHtml(title, artist) {
    let musicHtml = `<div class="songs">
            <input name="musicChoice" class="form-check-input" type="checkbox" value=""  onclick='doOpenCheck(this)' id="musicChoice">
            <label class="form-check-label" for="musicChoice" id="musicInfo">
                ${title}
                |
                ${artist}
            </label>
        </div>`;
    $(".musicListList").append(musicHtml);
  }

  let registerMusicBtn = document.querySelector("#registerMusic");
  registerMusicBtn.addEventListener("click", registerMusic());

  function registerMusic() {
    let listedMusic = document.querySelectorAll(".songs");
    for (let i = 0; i < listedMusic.length; i++) {
      if (listedMusic[i].querySelector("#musicChoice").checked) {
        let checkedMusic = listedMusic[i];
        let musicInfo = checkedMusic.querySelector("#musicInfo").innerHTML;
        let musicTitle = musicInfo.split("|")[0].trim();
        let musicArtist = musicInfo.split("|")[1].trim();

        onClickMusic(musicTitle, musicArtist);
      }
    }
  }

  const onClickMusic = async (music, artist) => {
    console.log(music);
    const url = "addMusicAjax/";
    const { data } = await axios.post(url, {
      music,
      artist,
    });
    
    musicHandleResponse(data.music, data.artist);
  };

  const musicHandleResponse = (music, artist) => {
    const titleInput = document.querySelector("#id_music");
    const artistInput = document.querySelector("#id_artist");

    titleInput.value = music;
    artistInput.value = artist;
    
    musictitleInput.style.backgroundColor = 'rgba(122, 71, 204, 0.2)'
    musicartistInput.style.backgroundColor = 'rgba(122, 71, 204, 0.2)'
    
    musicListListList.style.display='none';
  };

  function doOpenCheck(chk) {
    var obj = document.getElementsByName("musicChoice");
    for (var i = 0; i < obj.length; i++) {
      if (obj[i] != chk) {
        obj[i].checked = false;
      }
    }
  }

  function hashTagsToArray(tags) {
    console.log("!!")
    const hashTagArray = str.split(" ");
    
    for (let i = 0; i < hashTagArray.length; i++){
      //const element = document.querySelector(`.hashTag`);
      const newDiv = document.createElement('div');
      newDiv.setAttribute("class", "hashtag--btn");
      const newText = document.createTextNode(hashTagArray[i]);
      newDiv.appendChild(newText);
      const tagDiv = document.querySelector('.feed-hashtagList');
      tagDiv.append(newDiv);
    
    }
  }

  function autolink() {
    var container = document.getElementsByClassName("feed-content");
	for (let i = 0; i < container.length; i++) {
		var doc = container[i].innerHTML;
		var regURL = new RegExp("(http|https|ftp|telnet|news|irc)://([-/.a-zA-Z0-9_~#%$?&=:200-377()]+)","gi");
		container[i].innerHTML = doc.replace(regURL,"<a href='$1://$2' target='_blank'>$1://$2</a>");
	}
  }

  autolink();
  $(document).ready(function () {
        $("#feedForm").modal("show");
    });
</script>
{% endblock %}