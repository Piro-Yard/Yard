{% extends "searchBase.html" %} {% block content %}
<div id="feedAdd">
  <img src="{{ feed.userId.userImg.url }}" class="feed--userImg" alt="userImg">
  <a>
    <input type="text" type="submit" placeholder="글을 작성하려면 누르세요" data-bs-toggle="modal" data-bs-target="#feedForm"/>
  </a>
</div>
<div style="margin-top: 5rem">
  <p class="text-center my_search_text">검색 결과: <b>"{{query}}"</b></p>
</div>
<div class="feed-list">
    <!-- {% if messages %}
        <section id="messages">
            <script type="text/javascript">
                alert('검색어는 2글자 이상 입력해주세요.');
            </script>      
        </section>
        {% endif %} -->
        <div class="d-flex">
          <a href="{% url 'user:searchMyFeed' %}"><button value="myFeed">내 글 모아보기</button></a>
          <button>좋아요 모아보기</button>
        </div>
  
    {% for feed in feeds %}
    {% if request.user.id != feed.userId.id%}
    <div class="feed-container">
      <div class="feed--userInfo">
        <img src="{{ feed.userId.userImg.url }}" class="feed--userImg" alt="userImg">
        <p class="feed--userName">{{feed.userId.nickName}}</p>
      </div>
      <div class="feed--content">
        <p>{{feed.artist}} - {{feed.title}}</p>
        <p>{{feed.content}}</p>
        <p>{{feed.tags.all | join:" "}}</p>
        {% if feed.feedImg %}
          <img src="{{feed.feedImg.url}}" width="100" height="100" alt="">
        {% endif %}
       <!-- <a href="{% url 'user:feedDetail' feed.id%}">{{feed.feedName}}</a>-->
      </div>
    </div>
    {% else %}
    <div class="feed-container">
      <div class="feed--content-my">
          <p>{{feed.artist}} - {{feed.title}}</p>
          <p>{{feed.content}}</p>
          <p>{{feed.tags.all | join:" "}}</p>
          {% if feed.feedImg %}
            <img src="{{feed.feedImg.url}}" width="100" height="100" alt="">
          {% endif %}
         <!-- <a href="{% url 'user:feedDetail' feed.id%}">{{feed.feedName}}</a>-->
      </div>
      <div class="feed--userInfo">
        <img src="{{ feed.userId.userImg.url }}" class="feed--userImg" alt="userImg">
        <p class="feed--userName">{{feed.userId.nickName}}</p>
      </div>
    </div>
    {% endif %}
    {% empty %}
    <div class="">
      <p class="text-center my_search_text">
        해당 노래/가수의 피드가 아직없네요! 피드를 생성해보세요! &nbsp
      </p>
    </div>
    <a href="{% url 'user:main' %}">메인으로 이동하기</a>
    {% endfor %}
</div>
<!-- 피드 등록 폼 modal -->
<div id="feedForm" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" style="color: black;">피드 등록하기</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form class="searchDiv" action="methods" enctype="multipart/form-data">
          <label for="songinfo">음악 검색</label>
          <input
            type="text"
            id="songinfo"
            class="whatToSearch"
            placeholder="검색"
            autocomplete="off"
          />
          <input type="text" style="display: none" />
          <button type="button" onclick="addMusicList()">검색</button>
        </form>
        <div class="musicListList"></div>

        <button
          id="registerMusic"
          style="
            border-radius: 1rem;
            border-width: 0.1rem;
            background-color: cornflowerblue;
            color: white;
          "
          onclick="registerMusic()"
        >노래 등록
        </button>
        <form method="POST" class="post-form" enctype="multipart/form-data">
          {% csrf_token %} {{ form.as_p }}
          <a href="/mypage">
            <button type="submit" class="save btn btn-default">Save</button>
          </a>
        </form>
      </div>
    </div>
  </div>
</div>
<script
  src="https://code.jquery.com/jquery-3.5.1.js"
  integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc="
  crossorigin="anonymous"
></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
{% endblock %}
{% block js %}
<script>
  $(document).ready($(".musicList").empty());

  function addMusicList() {
    let musicKeyWord = $("#songinfo").val();
    $(".musicList").empty();
    $(".musicListList").empty();
    $.ajax({
      type: "GET",
      url:
        "http://ws.audioscrobbler.com/2.0/?method=track.search&track=" +
        musicKeyWord +
        "&api_key=91921c9761d97539ea8147f4599b5f3e&format=json",
      success: function (response) {
        let musicList = response["results"]["trackmatches"]["track"];
        for (let i = 0; i < musicList.length; i++) {
          let albumTitle = musicList[i]["name"];
          let albumArtist = musicList[i]["artist"];
          getMusicHtml(albumTitle, albumArtist);
        }
      },
    });
  }

  function getMusicHtml(title, artist) {
    let musicHtml = `<div class="songs">
            <input name="musicChoice" class="form-check-input" type="checkbox" value=""  onclick='doOpenCheck(this)' id="musicChoice">
            <label class="form-check-label" for="musicChoice" id="musicInfo">
                ${title}
                |
                ${artist}
            </label>
        </div>`;
    $(".musicListList").append(musicHtml);
  }

  let registerMusicBtn = document.querySelector("#registerMusic");
  registerMusicBtn.addEventListener("click", registerMusic());

  function registerMusic() {
    let listedMusic = document.querySelectorAll(".songs");
    for (let i = 0; i < listedMusic.length; i++) {
      if (listedMusic[i].querySelector("#musicChoice").checked) {
        let checkedMusic = listedMusic[i];
        let musicInfo = checkedMusic.querySelector("#musicInfo").innerHTML;
        let musicTitle = musicInfo.split("|")[0].trim();
        let musicArtist = musicInfo.split("|")[1].trim();

        onClickMusic(musicTitle, musicArtist);
      }
    }
  }

  const onClickMusic = async (music, artist) => {
    console.log(music);
    const url = "addMusicAjax/";
    const { data } = await axios.post(url, {
      music,
      artist,
    });
    musicHandleResponse(data.music, data.artist);
  };

  const musicHandleResponse = (music, artist) => {
    const titleInput = document.querySelector("#id_music");
    const artistInput = document.querySelector("#id_artist");

    titleInput.value = music;
    artistInput.value = artist;
  };

  function doOpenCheck(chk) {
    var obj = document.getElementsByName("musicChoice");
    for (var i = 0; i < obj.length; i++) {
      if (obj[i] != chk) {
        obj[i].checked = false;
      }
    }
  }
</script>
{% endblock %}