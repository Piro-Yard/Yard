{% extends "searchBase.html" %} {% block content %}
<div id="feedAdd">
  <img src="{{ feed.userId.userImg.url }}" class="feed--userImg" alt="userImg">
  <a>
    <input type="text" type="submit" placeholder="글을 작성하려면 누르세요" data-bs-toggle="modal" data-bs-target="#feedForm"/>
  </a>
</div>
<div style="margin-top: 5rem">
  <p class="text-center my_search_text">검색 결과: <b>"{{query}}"</b></p>
</div>
<div class="feed-list">
    <!-- {% if messages %}
        <section id="messages">
            <script type="text/javascript">
                alert('검색어는 2글자 이상 입력해주세요.');
            </script>      
        </section>
        {% endif %} -->
        <div class="d-flex">
          <a href="{% url 'user:searchMyFeed' %}"><button value="myFeed">내 글 모아보기</button></a>
          <button>좋아요 모아보기</button>
        </div>
  
    {% for feed in feeds %}
    {% if request.user.id != feed.userId.id%}
    <div class="feed-container">
      <div class="feed--userInfo">
        <img src="{{ feed.userId.userImg.url }}" class="feed--userImg" alt="userImg">
        <p class="feed--userName">{{feed.userId.nickName}}</p>
      </div>
      <div class="feed--content">
        <p>{{feed.artist}} - {{feed.title}}</p>
        <p>{{feed.content}}</p>
        <p>{{feed.tags.all | join:" "}}</p>
        {% if feed.feedImg %}
          <img src="{{feed.feedImg.url}}" width="100" height="100" alt="">
        {% endif %}
       <!-- <a href="{% url 'user:feedDetail' feed.id%}">{{feed.feedName}}</a>-->
      </div>
    </div>
    {% else %}
    <div class="feed-container">
      <div class="feed--content-my">
          <p>{{feed.artist}} - {{feed.title}}</p>
          <p>{{feed.content}}</p>
          <p>{{feed.tags.all | join:" "}}</p>
          {% if feed.feedImg %}
            <img src="{{feed.feedImg.url}}" width="100" height="100" alt="">
          {% endif %}
         <!-- <a href="{% url 'user:feedDetail' feed.id%}">{{feed.feedName}}</a>-->
      </div>
      <div class="feed--userInfo">
        <img src="{{ feed.userId.userImg.url }}" class="feed--userImg" alt="userImg">
        <p class="feed--userName">{{feed.userId.nickName}}</p>
      </div>
    </div>
    {% endif %}
    {% empty %}
    <div class="">
      <p class="text-center my_search_text">
        해당 노래/가수의 피드가 아직없네요! 피드를 생성해보세요! &nbsp
        <a href="{% url 'user:createFeed' %}">
          <button class="btn btn-secondary my-2 my-sm-0 center-block" type="submit">
            <i class="fas fa-plus-square"></i>
          </button>
        </a>
      </p>
    </div>
    <a href="{% url 'user:main' %}">메인으로 이동하기</a>
    {% endfor %}
</div>
<!-- 피드 등록 폼 modal -->
<div id="feedForm" class="modal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" style="color: black;">피드 등록하기</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id='feed-create' data-csrfmiddlewaretoken="{{ csrf_token }}">  //** form태그에 id와 datascrfmiddlewaretoken을 추가
          <div class="form-group">                                           //** Recipient를 모두 title로 변경하고, input 태그에 name속성 추가
            <label for="title" class="col-form-label">Title</label>
            <input type="text" name="title" class="form-control" id="title">
          </div>
          <div class="form-group">                                           //** Message 모두 content로 변경하고, input 태그에 name속성 추가
            <label for="content" class="col-form-label">Content</label>
            <textarea class="form-control" name="content" id="content"></textarea>
          </div>

          <!-- Modal footer를 form 태그 안으로 이동 -->
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button> //** 버튼내용 수정
            <button type="submit" class="btn btn-primary">만들기</button>                      //** 버튼내용 수정
          </div>
          <!-- 여기까지 -->
        </form>
      </div>
    </div>
  </div>
</div>
<script
  src="https://code.jquery.com/jquery-3.5.1.js"
  integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc="
  crossorigin="anonymous"
></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
{% endblock %}
{% block js %}
<script>

  $('#feed-create').submit((event) => {
    event.preventDefault() 
    
    $.ajax({
      url: '/createFeed/',
      method: 'POST',
      data: { 
        title: $(`input#title`).val(),
        content: $(`textarea#content-text`).val(),
        csrfmiddlewaretoken: $(event.currentTarget).data('csrfmiddlewaretoken')   // 장고 security와 관련해서 아무나 feed를 생성하지 못하도록 form 액션을 할 때는, csrf_token이 필요
      },
      dataType: "json",  // json => "javascript object notation"
      success(response) {
        console.log(response)
        window.location.href = '/feeds/'   //** redirect
      },
      error(response, status, error) {
        console.log(response, status, error);
      }
    })
  })

</script>
{% endblock %}
